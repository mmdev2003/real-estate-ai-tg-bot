# Core бот сервис для WeWall AI

## Описание
Репозиторий содержит кодовую базу с реализацией интеллектуальной начинки бота WeWall AI. Несмотря на то, что это основной сервис, существует также несколько сервисов, позволяющие боту интегрироваться в различные мессенджеры/чаты. Каждый сервис расположен в отдельном репозитории со своим собственным описанием:

1. `scheduler` - https://github.com/anatoly-bobrovsky/WeWall-scheduler;
2. `chat_connector` - https://github.com/anatoly-bobrovsky/WeWall-chat-connector;
3. `external_api` - https://github.com/anatoly-bobrovsky/WeWall-external-api;
4. `telegram_bot` - https://github.com/anatoly-bobrovsky/WeWall-telegram-bot;
5. `calculator` - https://github.com/anatoly-bobrovsky/WeWall-calculator;
6. `analog_search` - https://github.com/anatoly-bobrovsky/WeWall-analog-search;

Взаимосвязь сервисов представлена ниже в разделе "Инфографика".

## Инфографика
### Схема диалога
https://miro.com/app/board/uXjVKEBXmaM=/
### Архитектура системы
https://drive.google.com/file/d/126e2czCRRrCgptGPG5fCk3i6FI-QIPFR/view?usp=sharing
![Архитектура](./images/arch.png)

## Структура проекта
```
ci/                         # Инструменты CI/CD
    amocrm_api-2.6.1-py3-none-any.whl # fork amocrm_api (https://pypi.org/project/amocrm-api/)
    Dockerfile               # Dockerfile
    requirements.txt         # Зависимости
src/                        # Код
    bl/                      # Бизнес логика бота
        amocrm/              # Взаимодействие с amoCRM
            api_chats.py       # Gateway для контроля чатов на стороне amoCRM
            models.py          # Классы сущностей в amoCRM (контакты, сделки и т.д.)
            utils.py           # Вспомогательные функции (утилиты)
        langchain/            # Интеллектуальная начинка бота c FSM, основанная на langchain/langgraph
            edges/             # Рёбра графа
            nodes/             # Ноды графа
            tools/             # Тулзы для LLM (function-calling)
            check_agree.py     # Вызов LLM для определения "согласия"
            check_back.py      # Вызов LLM для определения "шага назад"
            client_utils.py    # Клиентские функции для исполнения графа и работы с памятью
            enums.py           # Нейминг нод и сообщений в БД
            main_graph.py      # Основной исполняемый граф диалога
            state_object.py    # Класс состояния, несущий в себе контекст между нодами
            utils.py           # Вспомогательные функции (утилиты)
        number_extractor/     # Реализация экстрактора чисел из русского текста
    db/                      # DB CRUD
        mongodb/              # MongoDB CRUD
            mongo_config.py    # Конфигурация параметров подключения, наименования коллекций
            mongo_crud.py      # Функции для обращения к БД
            schemas.py         # Дата классы ("схема") для MongoDB
        postgres/             # Реализация PostgreSQL чекпоинтера состояний
    api_app.py               # Точка входа, запуск приложения FastAPI
    bot_utils.py             # Вспомогательные функции (утилиты)
    env_settings.py          # Переменные среды
    log.py                   # Параметры логирования
    on_startup.py            # Действия перед запуском и выключением приложения
    routers.py               # Ендпоинты
    schemas.py               # Описание API схемы (pydantic модели)
    singleton_decorator.py   # Декоратор для паттерна "одиночка"
```

## Использование
### Сборка образов
Перед началом использования или после изменений необходимо собрать докер образ для этого сервиса, а также всех сервисов, указанных в описании выше. Для этого необходимо:
1. В файле .env прописать в переменную `REG` идентификатор реестра докер образов;
2. В файле .env прописать в переменную `TAG` актуальный тег образа;
3. Собрать образ с помощью команды `docker compose build core_bot`;
4. Отправить образ в реестр с помощью команды `docker push {имя образа}` (при локальном использовании можно не пушить образ в удалённый репозиторий);
5. Собрать похожим образом все оставшиеся сервисы (подробней написано в соответствующих репозиториях).

### Переменные среды
Для корректного функционирования сервиса необходимо указать переменные среды в `stack.env`, определённые в модуле `src/env_settings.py`. Такое же необходимо проделать для всех сервисов.

### Развёртывание системы
Для развёртывания необходимо:
1. Установить Docker;
2. Создать новые volumes: `mongodb-wewall`, `postgres-checkpointer-wewall` и `redis-wewall`;
3. Расширить файл `.env` переменными, которые обозначены в `docker-compose.yaml`, то есть именами и тегами всех! образов;
4. Сделать SSL сертификат, например, с помощью `certbot` и проставить правильные пути в переменные среды `SSL_KEYFILE` и `SSL_CERTFILE` в файле `stack.env` (файл нужно будет создать в текущей директории);
5. Если используется новое доменное имя, то нужно будет поменять вебхуки на стороне amoCRM: 
    - один из них можно поменять, написав в тех поддержку через аккаунт клиента примерно следующее: "Здравствуйте, не могли бы вы, пожалуйста, поменять Webhook URL для API чатов на https://{новый домен}/location/:scope_id";
    - второй можно поменять в "amoМаркете": в правом верхнем углу будет "+ Web Hooks", нажав на который необходимо будет заменить URL для события "Беседа изменена";
6. Дополнить `stack.env` файл с переменными среды  для всех! сервисов, если этого не сделали ранее;
7. Поднять сервисы с помощью команды `docker compose up -d`;
8. Накатить данные в базу MongoDB для следующих коллекций: `estates`, `messages`, `square_coeffs`, `subway_stations` и `way_to_subway_coeffs`;

После процедуры развёртывания клиентские приложения должны принимать и отвечать на сообщения, например, телеграм бот, токен которого был указан.
Стоит отметить, что локально можно тестировать без SSL сертификата и веб-хуков amoCRM - в этом случае указываем `SSL_KEYFILE` и `SSL_CERTFILE` пустыми.

## Дополнительная информация
### Техническая часть
Хотел бы дополнительно прокомментировать некоторые моменты. Большинство из них связано с нехваткой времени, маленькой командой (2 человека), а также текущей нагрузкой в 8 пользователей + минимальной обещанной нагрузкой в будущем:
1. Со стороны инфраструктуры сделан самый минимум - по сути это тоже самое, что и описано выше в локальном развёртывании, просто сделано на арендованном сервере. Никаких кластеров, скейлинга, расширенного мониторинга и т.д.;
2. Тоже самое касается CI/CD - его сейчас просто нет, всё делается вручную. Из-за этого, а также из-за первого пункта есть проблематика бесшовного обновления;
3. Не успели написать тесты;
4. По хорошему необходимо перейти на асинхронные запросы к MongoDB, либо перенести всё в PostgreSQL также на асинхру, чтобы не блокировать основной поток - тоже не успели;
5. Есть CPU-bound задачи - калькулятор и поиск аналогов. При больших нагрузках и росте БД недвижимости нужен будет автоскейлинг этих подов.
6. Опять-таки при росте нагрузки необходимо будет добавлять брокер сообщений для общения между сервисами, а также подрубать планировщик асинхронных задач (воркеры);
7. Не исключено наличие "говнокода", особенно в этой репе - обусловлено постоянными сменами требований и нехваткой времени на рефакторинг;
8. Нужно накатить NGINX!